# ================================================================================================
# LAYA AI Service - HTTPS Nginx Configuration Example
# ================================================================================================
#
# This file shows how to configure nginx as a reverse proxy for the LAYA AI Service
# with HTTPS/SSL support for production deployments.
#
# SETUP INSTRUCTIONS:
# 1. Copy this file to /etc/nginx/sites-available/laya-ai-service
# 2. Update server_name with your actual domain
# 3. Update SSL certificate paths
# 4. Create symlink: ln -s /etc/nginx/sites-available/laya-ai-service /etc/nginx/sites-enabled/
# 5. Test configuration: nginx -t
# 6. Reload nginx: systemctl reload nginx
#
# SSL CERTIFICATE SETUP (Let's Encrypt - Recommended):
# 1. Install certbot: apt-get install certbot python3-certbot-nginx
# 2. Obtain certificate: certbot --nginx -d api.yourdomain.com
# 3. Auto-renewal is configured automatically
#
# ================================================================================================

# HTTP Server - Redirect all HTTP traffic to HTTPS
server {
    # Listen on port 80 for HTTP
    listen 80;
    listen [::]:80;

    # Your domain name
    server_name api.yourdomain.com;

    # Redirect all HTTP requests to HTTPS (301 Permanent Redirect)
    return 301 https://$server_name$request_uri;
}

# HTTPS Server - Main application server
server {
    # Listen on port 443 for HTTPS
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Your domain name
    server_name api.yourdomain.com;

    # ============================================================================================
    # SSL/TLS Configuration
    # ============================================================================================

    # SSL Certificate and Private Key
    # If using Let's Encrypt:
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/api.yourdomain.com/chain.pem;

    # If using custom certificates:
    # ssl_certificate /etc/ssl/certs/yourdomain.crt;
    # ssl_certificate_key /etc/ssl/private/yourdomain.key;

    # SSL Session Configuration
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # Modern SSL Configuration (TLS 1.2 and 1.3 only)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # OCSP Stapling - Improves SSL performance
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # ============================================================================================
    # Security Headers
    # ============================================================================================

    # HTTP Strict Transport Security (HSTS)
    # Tell browsers to always use HTTPS (max-age = 1 year)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # X-Frame-Options - Prevent clickjacking
    add_header X-Frame-Options "DENY" always;

    # X-Content-Type-Options - Prevent MIME-type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # X-XSS-Protection - Enable XSS filter (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy - Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ============================================================================================
    # Logging
    # ============================================================================================

    access_log /var/log/nginx/laya-ai-service.access.log;
    error_log /var/log/nginx/laya-ai-service.error.log;

    # ============================================================================================
    # Proxy Configuration - Forward to FastAPI Application
    # ============================================================================================

    location / {
        # Forward to FastAPI application running on localhost:8000
        proxy_pass http://localhost:8000;

        # Preserve original request information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # CRITICAL: Tell FastAPI the original protocol was HTTPS
        # This is required for the HTTPS redirect middleware to work correctly
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Ssl on;

        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # ============================================================================================
    # Static Files (if serving static content)
    # ============================================================================================

    # location /static/ {
    #     alias /var/www/laya-ai-service/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # ============================================================================================
    # Health Check Endpoint (no auth required)
    # ============================================================================================

    location /health {
        proxy_pass http://localhost:8000/;
        proxy_set_header Host $host;
        access_log off;  # Don't log health checks
    }
}

# ================================================================================================
# Additional Configuration for Multiple Environments
# ================================================================================================

# For staging environment:
# server {
#     listen 443 ssl http2;
#     server_name staging-api.yourdomain.com;
#
#     ssl_certificate /etc/letsencrypt/live/staging-api.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/staging-api.yourdomain.com/privkey.pem;
#
#     location / {
#         proxy_pass http://localhost:8001;  # Staging runs on different port
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Ssl on;
#     }
# }

# ================================================================================================
# SSL Best Practices Checklist
# ================================================================================================
#
# ✓ Use TLS 1.2 and 1.3 only (disable TLS 1.0 and 1.1)
# ✓ Use strong cipher suites (ECDHE, AES-GCM, ChaCha20-Poly1305)
# ✓ Enable OCSP stapling for better performance
# ✓ Set HSTS header with long max-age (1 year minimum)
# ✓ Enable HSTS preloading for maximum security
# ✓ Use Let's Encrypt for free, auto-renewing certificates
# ✓ Set X-Forwarded-Proto header for application awareness
# ✓ Enable HTTP/2 for better performance
# ✓ Configure proper session cache for performance
# ✓ Disable SSL session tickets (privacy)
# ✓ Test configuration with SSL Labs: https://www.ssllabs.com/ssltest/
#
# ================================================================================================
# Testing Your Configuration
# ================================================================================================
#
# 1. Test nginx configuration syntax:
#    nginx -t
#
# 2. Check SSL certificate:
#    openssl s_client -connect api.yourdomain.com:443 -servername api.yourdomain.com
#
# 3. Test HTTPS redirect:
#    curl -I http://api.yourdomain.com
#    # Should return: HTTP/1.1 301 Moved Permanently
#    # Location: https://api.yourdomain.com/
#
# 4. Test HSTS header:
#    curl -I https://api.yourdomain.com
#    # Should include: Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
#
# 5. SSL Labs Test (comprehensive security analysis):
#    https://www.ssllabs.com/ssltest/analyze.html?d=api.yourdomain.com
#    # Target: A+ rating
#
# ================================================================================================
