name: Gibbon Modules CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'gibbon/**'
      - 'modules/**'
      - '.github/workflows/gibbon-modules.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'gibbon/**'
      - 'modules/**'
      - '.github/workflows/gibbon-modules.yml'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, bcmath
          tools: composer:v2, phpunit, phpcs
          coverage: xdebug

      - name: Validate composer.json
        run: |
          if [ -f "composer.json" ]; then
            composer validate --strict
          else
            echo "No composer.json found, skipping validation"
          fi

      - name: Install dependencies
        run: |
          if [ -f "composer.json" ]; then
            composer install --prefer-dist --no-progress --no-suggest
          else
            echo "No composer.json found, installing PHPUnit and PHPCS globally"
            composer global require phpunit/phpunit:^9.5
            composer global require squizlabs/php_codesniffer:^3.7
          fi

      - name: Run PHP CodeSniffer
        run: |
          if command -v phpcs &> /dev/null; then
            phpcs --standard=PSR12 --extensions=php --ignore=*/vendor/*,*/node_modules/* gibbon/ modules/ || true
          else
            echo "PHPCS not available, checking basic PHP syntax"
            find gibbon/ modules/ -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
          fi
        continue-on-error: false

      - name: Run PHPUnit tests
        run: |
          # Find all test files
          TEST_FILES=$(find gibbon/ modules/ -path "*/tests/*Test.php" -o -path "*/Tests/*Test.php" 2>/dev/null || echo "")

          if [ -z "$TEST_FILES" ]; then
            echo "No test files found, skipping tests"
            exit 0
          fi

          # Run PHPUnit with coverage
          if command -v phpunit &> /dev/null; then
            phpunit --testdox \
              --coverage-html coverage/ \
              --coverage-clover coverage.xml \
              --coverage-text \
              --colors=always \
              gibbon/ modules/ || echo "Some tests may have failed"
          else
            echo "PHPUnit not available, skipping tests"
          fi
        continue-on-error: false
        env:
          XDEBUG_MODE: coverage

      - name: Check code coverage threshold
        run: |
          if [ -f "coverage.xml" ]; then
            # Extract coverage percentage from clover XML
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage.xml');
              if (\$xml === false) exit(1);
              \$metrics = \$xml->project->metrics;
              \$statements = (int)\$metrics['statements'];
              \$coveredstatements = (int)\$metrics['coveredstatements'];
              if (\$statements > 0) {
                \$coverage = (\$coveredstatements / \$statements) * 100;
                echo round(\$coverage, 2);
              } else {
                echo '0';
              }
            ")

            echo "Code coverage: ${COVERAGE}%"

            # Fail if coverage is below 80%
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "Error: Code coverage ${COVERAGE}% is below the required 80% threshold"
              exit 1
            fi
          else
            echo "No coverage.xml found, skipping coverage check"
          fi
        continue-on-error: false

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always()
        with:
          file: ./coverage.xml
          flags: gibbon-modules
          name: gibbon-modules-coverage
        continue-on-error: true

      - name: Archive coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-gibbon-modules
          path: coverage/
          retention-days: 30
