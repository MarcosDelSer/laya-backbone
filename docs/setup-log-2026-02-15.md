# LAYA Backbone - Setup & Configuration Log

**Date:** February 15, 2026
**Platform:** macOS (darwin 23.6.0)

---

## 1. Docker Compose Setup

### Problem: `docker-compose` command not found
The legacy `docker-compose` (v1, hyphenated) was not installed. Docker Compose V2 was available as a Docker plugin.

**Fix:** Use `docker compose` (with a space) instead of `docker-compose`.

### Problem: No configuration file found
The `docker-compose.yml` and `docker/` directory only existed inside `.auto-claude/worktrees/tasks/001-laya-implementation-plan-docx/`, not in the project root.

**Fix:** Copied `docker-compose.yml` and `docker/` directory from the worktree to the project root.

### Problem: Docker daemon not running
`docker compose up -d` failed with "Cannot connect to the Docker daemon."

**Fix:** Opened Docker Desktop application and waited for it to start.

### Problem: Port 5432 already in use
A local PostgreSQL instance was already bound to port 5432, preventing the `laya-postgres` container from starting.

**Fix:** Changed the host port mapping in `docker-compose.yml` from `5432` to `5433`:
```yaml
# Before
- "${POSTGRES_PORT:-5432}:5432"
# After
- "${POSTGRES_PORT:-5433}:5432"
```

**Result:** All 5 containers running and healthy:
| Container | Service | Port |
|-----------|---------|------|
| laya-mysql | MySQL 8.0 | localhost:3306 |
| laya-postgres | PostgreSQL 12 | localhost:5433 |
| laya-redis | Redis 7 | localhost:6379 |
| laya-php | PHP-FPM 8.3 | internal:9000 |
| laya-nginx | Nginx | localhost:8080 |

---

## 2. Gibbon CMS Installation

### Problem: 403 Forbidden from Nginx
The `gibbon/` directory was nearly empty — only contained custom LAYA modules (`CareTracking`, `NotificationEngine`, `PhotoManagement`) but no Gibbon CMS core files.

**Fix:** Downloaded Gibbon CMS v30.0.01 from GitHub:
```
https://github.com/GibbonEdu/core/archive/refs/tags/v30.0.01.tar.gz
```
Extracted into `gibbon/` while preserving the existing custom LAYA modules.

### Problem: Missing Composer autoloader
Gibbon requires vendor dependencies installed via Composer.

**Fix:**
1. Installed Composer inside the PHP container
2. Installed `libintl` package (required by ext-gettext at runtime)
3. Ran `composer install --no-dev --optimize-autoloader`

### Problem: PHP `gettext` extension not working
The Dockerfile's cleanup step removed `gettext-dev` which also removed the `libintl` shared library needed at runtime.

**Fix:**
1. Installed `libintl` and rebuilt the gettext extension inside the container
2. Updated the Dockerfile to preserve `libintl` during cleanup:
```dockerfile
RUN apk add --no-cache libintl \
    && apk del \
    freetype-dev \
    ...
```

### Problem: HTTPS/Secure cookie issues preventing installer from working
Two related issues:
1. **Secure cookies over HTTP:** Gibbon's `SessionFactory.php` uses `isset($_SERVER['HTTPS'])` to set the `secure` cookie flag. Nginx's `fastcgi_params` includes `HTTPS $https if_not_empty`, and the config also had `fastcgi_param HTTPS off`. Since `isset('off')` returns `true`, PHP thought HTTPS was active and set `secure` flag on cookies. The browser then refused to send cookies back over HTTP.
2. **HTTPS URL generation:** Gibbon's `InstallController::guessAbsoluteUrl()` checks `!empty($_SERVER['HTTPS'])` and generated `https://` URLs.

**Fix:** Removed all `fastcgi_param HTTPS off;` lines from `docker/nginx/gibbon.conf` (3 locations). The standard `fastcgi_params` file handles it correctly with `$https if_not_empty` — on HTTP connections, `$https` is empty so it's not passed at all.

Also added `session.cookie_secure = Off` to `docker/php/php.ini` as an explicit safety measure.

### Problem: PHP sessions not persisting
The session save path `/var/lib/php/sessions` did not exist inside the container, so PHP could not store sessions. Every request created a new session, causing the "Please login" error on form submission.

**Fix:**
1. Created the directory inside the running container:
   ```bash
   mkdir -p /var/lib/php/sessions
   chown www-data:www-data /var/lib/php/sessions
   chmod 1733 /var/lib/php/sessions
   ```
2. Updated the Dockerfile to create it on build:
   ```dockerfile
   RUN mkdir -p /var/www/html/gibbon/uploads \
       && mkdir -p /var/lib/php/sessions \
       && chown www-data:www-data /var/lib/php/sessions \
       && chmod 1733 /var/lib/php/sessions \
       && chown -R www-data:www-data /var/www/html/gibbon
   ```

### Gibbon Installation Completed
Successfully completed the 4-step web installer at `http://localhost:8080/installer/install.php`:
1. System Requirements — all passed
2. Database Settings — host: `mysql`, db: `gibbon`, user: `gibbon`, pass: `gibbon_password`
3. User Account — created admin user
4. Installation Complete

### Problem: Admin username typo
Username was accidentally saved as `amin` instead of `admin` during installation.

**Fix:** Updated directly in MySQL:
```sql
UPDATE gibbonPerson SET username='admin' WHERE gibbonPersonID='0000000001';
```

---

## 3. Gibbon Admin Access

- **URL:** http://localhost:8080
- **Username:** `admin`
- **Password:** `Laya_admin_2026`

### Docker Persistence
- Database is stored in Docker volume `mysql_data` — persists across `docker compose down` / `up`
- Gibbon files are on the local filesystem in `gibbon/` — mounted into the container
- Only `docker compose down -v` would wipe the database (the `-v` flag removes volumes)

---

## 4. PR Conflict Resolution & Merging

### PR #5 — Activity Intelligence Engine (`auto-claude/006-task-e-activity-intelligence`)
### PR #6 — Business Intelligence Dashboard (`auto-claude/008-task-g-business-intelligence`)

Both PRs had merge conflicts against `main` because they modified the same shared files in `ai-service/`:

**Conflicting files:**
- `ai-service/alembic/env.py`
- `ai-service/app/dependencies.py`
- `ai-service/app/main.py`
- `ai-service/app/models/__init__.py`
- `ai-service/app/routers/__init__.py`
- `ai-service/app/services/__init__.py`
- `ai-service/tests/__init__.py`
- `ai-service/tests/conftest.py`

**Root cause:** Each PR replaced the existing coaching feature imports/exports with only their own feature, instead of adding alongside them.

**Resolution strategy:** For each PR, merged `main` into the PR branch and resolved conflicts by combining all feature sets:

#### PR #5 Resolution (coaching + activity):
- `models/__init__.py`: Exports both `CoachingSession`, `CoachingRecommendation`, `EvidenceSource` AND `Activity`, `ActivityType`, `ActivityDifficulty`, `ActivityRecommendation`, `ActivityParticipation`
- `main.py`: Registers both `coaching.router` and `activities_router`
- `routers/__init__.py`: Exports both `coaching_router` and `activities_router`
- `services/__init__.py`: Exports both `CoachingService` and `ActivityService`
- `conftest.py`: Combined test fixtures for both coaching and activity domains
- `dependencies.py`: Used modern `X | None` syntax with `from __future__ import annotations`

#### PR #6 Resolution (coaching + activity + analytics):
After PR #5 was merged, PR #6 needed to be updated to include all three feature sets:
- All shared files updated to import/export coaching, activity, AND analytics features
- `main.py` registers all three routers: coaching, activities, analytics
- `alembic/env.py` imports all model sets for migration autogeneration

**Merge order:**
1. Resolved and merged PR #5 first
2. Re-resolved PR #6 against updated main (now containing activity features)
3. Merged PR #6

**Result:** All 7 PRs in the repository are now merged into `main`.

---

## 5. Files Modified/Created

### Docker configuration (project root):
- `docker-compose.yml` — copied from worktree, PostgreSQL port changed to 5433
- `docker/nginx/gibbon.conf` — removed `HTTPS off` fastcgi params
- `docker/php/php.ini` — added `session.cookie_secure = Off`
- `docker/php/Dockerfile` — added `libintl` preservation, session directory creation

### Gibbon CMS:
- `gibbon/` — populated with Gibbon v30.0.01 source code + Composer vendor dependencies
- Custom modules preserved: `CareTracking`, `NotificationEngine`, `PhotoManagement`

### AI Service (via PR merges):
- Activity intelligence: models, router, service, tests
- Business intelligence: models, router, service, schemas, migration
- All shared `__init__.py` files updated to export all three feature domains
